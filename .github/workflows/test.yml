name: Test Workflow

on:
  workflow_call:
  push:
    branches:
      - main

jobs:
  lint-build:
    runs-on: ubuntu-latest
    name: Lint & Build
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  download-test:
    needs: lint-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        case:
          - name: success
            mappings: |
              {
                "argon-pro-flutter/chat-screen.jpg": "app/screen.jpg",
                "argon-pro-flutter/beauty-screen.jpg": "next/beauty.jpg"
              }
            expect_failure: false
          - name: failure
            mappings: |
              {
                "argon-pro-flutter/this-file-does-not-exist.jpg": "bad/output.jpg"
              }
            expect_failure: true
    name: Download Test - ${{ matrix.case.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download files
        id: download
        continue-on-error: ${{ matrix.case.expect_failure }}
        uses: ./
        with:
          owner: creativetimofficial
          repo: public-assets
          ref: master
          token: ${{ secrets.GITHUB_TOKEN }}
          mappings: ${{ matrix.case.mappings }}
          output-directory: downloads

      - name: Print downloaded files
        if: ${{ !matrix.case.expect_failure }}
        run: |
          echo "✅ Downloaded files:"
          echo "${{ steps.download.outputs.files }}"

      - name: Verify failure
        if: ${{ matrix.case.expect_failure && steps.download.outcome == 'success' }}
        run: |
          echo "❌ Expected this step to fail but it succeeded"
          exit 1

      - name: Add summary
        run: |
          echo "### Test Case: ${{ matrix.case.name }}" >> $GITHUB_STEP_SUMMARY
          echo "Outcome: ${{ steps.download.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "Files: ${{ steps.download.outputs.files }}" >> $GITHUB_STEP_SUMMARY
