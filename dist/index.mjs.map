{"version":3,"file":"index.mjs","names":["options: RequestOptions"],"sources":["../src/utils.ts","../src/main.ts","../src/index.ts"],"sourcesContent":["import { createWriteStream, type Dirent } from \"node:fs\";\nimport { readdir, stat } from \"node:fs/promises\";\nimport { get, type RequestOptions } from \"node:https\";\nimport { join } from \"node:path\";\n\nexport type FileMapping = [string, string];\n\nasync function download(\n\turl: string,\n\toptions: RequestOptions,\n\toutputPath: string,\n): Promise<void> {\n\treturn new Promise((resolve, reject) => {\n\t\tconst fileStream = createWriteStream(outputPath);\n\t\tfileStream.on(\"error\", reject);\n\n\t\tconst req = get(url, options, (res) => {\n\t\t\tif (res.statusCode && res.statusCode >= 400) {\n\t\t\t\tres.resume();\n\t\t\t\treturn reject(\n\t\t\t\t\tnew Error(`Failed to download ${url} (status ${res.statusCode})`),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tres.pipe(fileStream);\n\n\t\t\tfileStream.on(\"finish\", () => {\n\t\t\t\tfileStream.close((err) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn reject(err);\n\t\t\t\t\t}\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\treq.on(\"error\", reject);\n\n\t\treq.setTimeout(15000, () => {\n\t\t\treq.destroy(new Error(`Request timed out for ${url}`));\n\t\t});\n\t});\n}\n\nasync function getFiles(directory: string): Promise<string[]> {\n\tconst dirents: Dirent[] = (await readdir(directory, {\n\t\trecursive: true,\n\t\twithFileTypes: true,\n\t})) as unknown as Dirent[];\n\treturn dirents\n\t\t.filter((dirent) => dirent.isFile())\n\t\t.map((dirent) => join(directory, dirent.name));\n}\n\nasync function parseMappings(mappings: string[]): Promise<FileMapping[]> {\n\tconst mappingStr = mappings.join(\"\");\n\treturn Object.entries(JSON.parse(mappingStr));\n}\n\nasync function logFileDownload(\n\tinput: string,\n\toutputPath: string,\n): Promise<void> {\n\tconst { size } = await stat(outputPath);\n\tconst sizeStr =\n\t\tsize < 1024 ? `${size} bytes` : `${(size / 1024).toFixed(2)} KB`;\n\tconsole.log(\n\t\t`\\nðŸ“¥ File Downloaded!\\n` +\n\t\t\t`   â€¢ Source:      \\x1b[36m${input}\\x1b[0m\\n` +\n\t\t\t`   â€¢ Saved as:    \\x1b[32m${outputPath}\\x1b[0m\\n` +\n\t\t\t`   â€¢ Size:        \\x1b[33m${sizeStr}\\x1b[0m\\n` +\n\t\t\t`----------------------------------------`,\n\t);\n}\n\nexport { download, getFiles, parseMappings, logFileDownload };\n","import { mkdir } from \"node:fs/promises\";\nimport type { RequestOptions } from \"node:https\";\nimport { dirname, join } from \"node:path\";\nimport { getInput, getMultilineInput, setFailed, summary } from \"@actions/core\";\nimport {\n\tdownload,\n\ttype FileMapping,\n\tgetFiles,\n\tlogFileDownload,\n\tparseMappings,\n} from \"./utils.js\";\n\nexport async function run(): Promise<void> {\n\ttry {\n\t\tconst repo = getInput(\"repo\", { required: true });\n\t\tconst ref = getInput(\"ref\") || \"main\";\n\t\tconst pat = getInput(\"git-pat\");\n\t\tconst outputDir = getInput(\"output-directory\");\n\t\tconst options: RequestOptions = pat\n\t\t\t? { headers: { Authorization: `token ${pat}` } }\n\t\t\t: {};\n\n\t\tconst mappings = await parseMappings(getMultilineInput(\"mappings\"));\n\t\tconst props = { repo, ref, options, outputDir };\n\n\t\tconst downloadedFiles = await downloadMappedFiles(mappings, props);\n\n\t\tconst allFiles = outputDir ? await getFiles(outputDir) : downloadedFiles;\n\n\t\tawait summary\n\t\t\t.addHeading(\"ðŸ“¦ GitHub Downloader Action Summary\")\n\t\t\t.addBreak()\n\t\t\t.addRaw(`**Repository:** ${repo}`)\n\t\t\t.addBreak()\n\t\t\t.addRaw(`**Branch:** ${ref}`)\n\t\t\t.addSeparator()\n\t\t\t.addHeading(\"Downloaded Files\", 2)\n\t\t\t.addTable([\n\t\t\t\t[\n\t\t\t\t\t{ data: \"Source Path\", header: true },\n\t\t\t\t\t{ data: \"Saved As\", header: true },\n\t\t\t\t],\n\t\t\t\t...mappings.map(([src, _], i) => [src, downloadedFiles[i]]),\n\t\t\t])\n\t\t\t.addSeparator()\n\t\t\t.addHeading(\"Output Directory Files\", 2)\n\t\t\t.addBreak()\n\t\t\t.addRaw(\n\t\t\t\toutputDir\n\t\t\t\t\t? allFiles.length\n\t\t\t\t\t\t? allFiles.map((f) => `- ${f}`).join(\"\\n\\n\")\n\t\t\t\t\t\t: \"_No files found in output directory._\"\n\t\t\t\t\t: \"_No output directory specified._\",\n\t\t\t)\n\t\t\t.write();\n\t} catch (error) {\n\t\tsetFailed(error instanceof Error ? error.message : String(error));\n\t}\n}\n\ninterface DownloadProps {\n\trepo: string;\n\tref: string;\n\toptions: RequestOptions;\n\toutputDir: string;\n}\n\nasync function downloadMappedFiles(\n\tmappings: FileMapping[],\n\t{ repo, ref, options, outputDir }: DownloadProps,\n): Promise<string[]> {\n\tasync function downloadSingleFile(mapping: FileMapping): Promise<string> {\n\t\tconst [source, destination] = mapping;\n\t\tconst outputPath = outputDir ? join(outputDir, destination) : destination;\n\t\tconst url = `https://raw.githubusercontent.com/${repo}/${ref}/${source}`;\n\n\t\tawait mkdir(dirname(outputPath), { recursive: true });\n\t\tawait download(url, options, outputPath);\n\t\tawait logFileDownload(source, outputPath);\n\n\t\treturn outputPath;\n\t}\n\n\treturn Promise.all(mappings.map(downloadSingleFile));\n}\n","import { run } from \"./main.js\";\n\nrun();\n"],"mappings":"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"}